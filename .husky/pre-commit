#!/usr/bin/env sh
# -*- coding: utf-8 -*-

echo "ğŸ” Running pre-commit checks for changed Python files..."

# ç¡®ä¿è„šæœ¬å‡ºé”™æ—¶ç«‹å³é€€å‡º
set -e

# æ£€æŸ¥ black æ˜¯å¦å®‰è£…
if ! command -v black >/dev/null 2>&1; then
  echo "âš ï¸  black æœªå®‰è£…ã€‚è¯·è¿è¡Œ: pip install black"
  exit 1
fi

# è·å–æš‚å­˜åŒºä¸­ä¿®æ”¹æˆ–æ–°å¢çš„ Python æ–‡ä»¶åˆ—è¡¨
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.py$' || true)

# å¦‚æœæ²¡æœ‰ Python æ–‡ä»¶æ”¹åŠ¨ï¼Œå°±ç›´æ¥è·³è¿‡
if [ -z "$CHANGED_FILES" ]; then
  echo "âœ… æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„ Python æ–‡ä»¶ï¼Œè·³è¿‡æ ¼å¼æ£€æŸ¥ã€‚"
  exit 0
fi

echo "ğŸ–¤ æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ï¼š"
echo "$CHANGED_FILES"
echo "-----------------------------------"

# å…ˆæ£€æŸ¥æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ
black --check "$CHANGED_FILES" >/dev/null 2>&1

# å¦‚æœæ ¼å¼ä¸ç¬¦åˆï¼Œåˆ™è‡ªåŠ¨æ ¼å¼åŒ–å¹¶é‡æ–°æš‚å­˜
if [ $? -ne 0 ]; then
  echo "ğŸ’¥ æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ï¼Œæ­£åœ¨è‡ªåŠ¨æ ¼å¼åŒ–..."
  black "$CHANGED_FILES"

  echo "âœ¨ é‡æ–°æš‚å­˜æ ¼å¼åŒ–åçš„æ–‡ä»¶..."
  git add "$CHANGED_FILES"
  echo "âœ… å·²è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜ï¼"
else
  echo "âœ… æ‰€æœ‰æ–‡ä»¶æ ¼å¼è§„èŒƒã€‚"
fi

# ï¼ˆå¯é€‰ï¼‰è¿è¡Œ flake8 ç­‰é™æ€æ£€æŸ¥
# if command -v flake8 >/dev/null 2>&1; then
#   echo "ğŸ§ª è¿è¡Œ flake8..."
#   flake8 $CHANGED_FILES
# fi

echo "ğŸš€ æäº¤é€šè¿‡ï¼"
exit 0
